using System;
using System.Collections.Generic;
using System.Linq;
using System.Runtime.Remoting.Metadata.W3cXsd2001;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ViewSpsLogger
{
    public class SqlCode : ISqlCode
    {
        private int _count;
        private int _maxCount = 4;

        private string GetSqlCodeAutoclave1(DateTime dateTime) 
        {
           return $"-- Запрос с оптимизированной логикой для autoclave1\r\nWITH UniqueData461 AS (\r\n    SELECT DISTINCT Data_461\r\n    FROM autoclave1\r\n    WHERE Timestamp >= '{dateTime.ToString("yyyy-MM-dd")}' AND Timestamp < '{ReturnsTheNextDay(dateTime).ToString("yyyy-MM-dd")}'\r\n),\r\n\r\nAllRelevantRecords AS (\r\n    SELECT a1.Data_461, a1.Timestamp, a1.Data_445, a1.Data_443\r\n    FROM autoclave1 a1\r\n    JOIN UniqueData461 ud ON a1.Data_461 = ud.Data_461\r\n),\r\n\r\nDataTimings AS (\r\n    SELECT \r\n        Data_461,\r\n        MIN(Timestamp) AS FirstTimestamp,\r\n        MAX(Timestamp) AS LastTimestamp,\r\n        LEAD(MIN(Timestamp)) OVER (ORDER BY Data_461) AS NextGroupFirstTimestamp\r\n    FROM AllRelevantRecords\r\n    GROUP BY Data_461\r\n),\r\n\r\nFilteredData AS (\r\n    SELECT \r\n        dt.Data_461,\r\n        ar.Timestamp,\r\n        ar.Data_445,\r\n        ar.Data_443,\r\n        dt.FirstTimestamp,\r\n        dt.LastTimestamp,\r\n        dt.NextGroupFirstTimestamp\r\n    FROM AllRelevantRecords ar\r\n    JOIN DataTimings dt ON ar.Data_461 = dt.Data_461\r\n    WHERE ar.Data_443 = 5 AND ar.Data_445 <= 0.08\r\n),\r\n\r\nGroupedData AS (\r\n    SELECT \r\n        Data_461,\r\n        FirstTimestamp,\r\n        LastTimestamp,\r\n        NextGroupFirstTimestamp,\r\n        COUNT(*) AS CountMeetCondition\r\n    FROM FilteredData\r\n    WHERE NextGroupFirstTimestamp IS NOT NULL AND NextGroupFirstTimestamp > LastTimestamp\r\n    GROUP BY Data_461, FirstTimestamp, LastTimestamp, NextGroupFirstTimestamp\r\n)\r\n\r\nSELECT \r\n    FirstTimestamp,\r\n    \"Autoclave 1\",\r\n    CountMeetCondition,\r\n    TIMEDIFF(NextGroupFirstTimestamp, LastTimestamp) AS TimeDifference\r\nFROM GroupedData;";
        }

        private string GetSqlCodeAutoclave2(DateTime dateTime)
        {
            return $"-- Запрос с оптимизированной логикой для autoclave1\r\nWITH UniqueData461 AS (\r\n    SELECT DISTINCT Data_461\r\n    FROM autoclave1\r\n    WHERE Timestamp >= '{dateTime.ToString("yyyy-MM-dd")}' AND Timestamp < '{ReturnsTheNextDay(dateTime).ToString("yyyy-MM-dd")}'\r\n),\r\n\r\nAllRelevantRecords AS (\r\n    SELECT a1.Data_461, a1.Timestamp, a1.Data_445, a1.Data_443\r\n    FROM autoclave1 a1\r\n    JOIN UniqueData461 ud ON a1.Data_461 = ud.Data_461\r\n),\r\n\r\nDataTimings AS (\r\n    SELECT \r\n        Data_461,\r\n        MIN(Timestamp) AS FirstTimestamp,\r\n        MAX(Timestamp) AS LastTimestamp,\r\n        LEAD(MIN(Timestamp)) OVER (ORDER BY Data_461) AS NextGroupFirstTimestamp\r\n    FROM AllRelevantRecords\r\n    GROUP BY Data_461\r\n),\r\n\r\nFilteredData AS (\r\n    SELECT \r\n        dt.Data_461,\r\n        ar.Timestamp,\r\n        ar.Data_445,\r\n        ar.Data_443,\r\n        dt.FirstTimestamp,\r\n        dt.LastTimestamp,\r\n        dt.NextGroupFirstTimestamp\r\n    FROM AllRelevantRecords ar\r\n    JOIN DataTimings dt ON ar.Data_461 = dt.Data_461\r\n    WHERE ar.Data_443 = 5 AND ar.Data_445 <= 0.08\r\n),\r\n\r\nGroupedData AS (\r\n    SELECT \r\n        Data_461,\r\n        FirstTimestamp,\r\n        LastTimestamp,\r\n        NextGroupFirstTimestamp,\r\n        COUNT(*) AS CountMeetCondition\r\n    FROM FilteredData\r\n    WHERE NextGroupFirstTimestamp IS NOT NULL AND NextGroupFirstTimestamp > LastTimestamp\r\n    GROUP BY Data_461, FirstTimestamp, LastTimestamp, NextGroupFirstTimestamp\r\n)\r\n\r\nSELECT \r\n    FirstTimestamp,\r\n    \"Autoclave 2\",\r\n    CountMeetCondition,\r\n    TIMEDIFF(NextGroupFirstTimestamp, LastTimestamp) AS TimeDifference\r\nFROM GroupedData;\r\n";
        }

        private string GetSqlCodeAutoclave3(DateTime dateTime)
        {
            return $"-- Запрос с оптимизированной логикой для autoclave3\r\nWITH UniqueData93 AS (\r\n    SELECT DISTINCT Data_93\r\n    FROM autoclave3\r\n    WHERE Timestamp >= '{dateTime.ToString("yyyy-MM-dd")}' AND Timestamp < '{ReturnsTheNextDay(dateTime).ToString("yyyy-MM-dd")}'\r\n),\r\n\r\nAllRelevantRecords AS (\r\n    SELECT a3.Data_93, a3.Timestamp, a3.Data_61, a3.Data_57\r\n    FROM autoclave3 a3\r\n    JOIN UniqueData93 ud ON a3.Data_93 = ud.Data_93\r\n),\r\n\r\nDataTimings AS (\r\n    SELECT \r\n        Data_93,\r\n        MIN(Timestamp) AS FirstTimestamp,\r\n        MAX(Timestamp) AS LastTimestamp,\r\n        LEAD(MIN(Timestamp)) OVER (ORDER BY Data_93) AS NextGroupFirstTimestamp\r\n    FROM AllRelevantRecords\r\n    GROUP BY Data_93\r\n),\r\n\r\nFilteredData AS (\r\n    SELECT \r\n        dt.Data_93,\r\n        ar.Timestamp,\r\n        ar.Data_61,\r\n        ar.Data_57,\r\n        dt.FirstTimestamp,\r\n        dt.LastTimestamp,\r\n        dt.NextGroupFirstTimestamp\r\n    FROM AllRelevantRecords ar\r\n    JOIN DataTimings dt ON ar.Data_93 = dt.Data_93\r\n    WHERE ar.Data_57 = 5 AND ar.Data_61 <= 0.08\r\n),\r\n\r\nGroupedData AS (\r\n    SELECT \r\n        Data_93,\r\n        FirstTimestamp,\r\n        LastTimestamp,\r\n        NextGroupFirstTimestamp,\r\n        COUNT(*) AS CountMeetCondition\r\n    FROM FilteredData\r\n    WHERE NextGroupFirstTimestamp IS NOT NULL AND NextGroupFirstTimestamp > LastTimestamp\r\n    GROUP BY Data_93, FirstTimestamp, LastTimestamp, NextGroupFirstTimestamp\r\n)\r\n\r\nSELECT \r\n    FirstTimestamp,\r\n    \"Autoclave 3\",\r\n    CountMeetCondition,\r\n    TIMEDIFF(NextGroupFirstTimestamp, LastTimestamp) AS TimeDifference\r\nFROM GroupedData;\r\n";
        }

        private string GetSqlCodeAutoclave4(DateTime dateTime)
        {
            return $"-- Запрос с оптимизированной логикой для autoclave4\r\nWITH UniqueData52 AS (\r\n    SELECT DISTINCT Data_52\r\n    FROM autoclave4\r\n    WHERE Timestamp >= '{dateTime.ToString("yyyy-MM-dd")}' AND Timestamp < '{ReturnsTheNextDay(dateTime).ToString("yyyy-MM-dd")}'\r\n),\r\n\r\nAllRelevantRecords AS (\r\n    SELECT a4.Data_52, a4.Timestamp, a4.Data_36, a4.Data_34\r\n    FROM autoclave4 a4\r\n    JOIN UniqueData52 ud ON a4.Data_52 = ud.Data_52\r\n),\r\n\r\nDataTimings AS (\r\n    SELECT \r\n        Data_52,\r\n        MIN(Timestamp) AS FirstTimestamp,\r\n        MAX(Timestamp) AS LastTimestamp,\r\n        LEAD(MIN(Timestamp)) OVER (ORDER BY Data_52) AS NextGroupFirstTimestamp\r\n    FROM AllRelevantRecords\r\n    GROUP BY Data_52\r\n),\r\n\r\nFilteredData AS (\r\n    SELECT \r\n        dt.Data_52,\r\n        ar.Timestamp,\r\n        ar.Data_36,\r\n        ar.Data_34,\r\n        dt.FirstTimestamp,\r\n        dt.LastTimestamp,\r\n        dt.NextGroupFirstTimestamp\r\n    FROM AllRelevantRecords ar\r\n    JOIN DataTimings dt ON ar.Data_52 = dt.Data_52\r\n    WHERE ar.Data_34 = 5 AND ar.Data_36 <= 0.08\r\n),\r\n\r\nGroupedData AS (\r\n    SELECT \r\n        Data_52,\r\n        FirstTimestamp,\r\n        LastTimestamp,\r\n        NextGroupFirstTimestamp,\r\n        COUNT(*) AS CountMeetCondition\r\n    FROM FilteredData\r\n    WHERE NextGroupFirstTimestamp IS NOT NULL AND NextGroupFirstTimestamp > LastTimestamp\r\n    GROUP BY Data_52, FirstTimestamp, LastTimestamp, NextGroupFirstTimestamp\r\n)\r\n\r\nSELECT \r\n    FirstTimestamp,\r\n    \"Autoclave 4\",\r\n    CountMeetCondition,\r\n    TIMEDIFF(NextGroupFirstTimestamp, LastTimestamp) AS TimeDifference\r\nFROM GroupedData;";
        }

        private string GetSqlCodeAutoclaveFull(DateTime dateTime)
        {
            string startDate = dateTime.ToString("yyyy-MM-dd");
            string endDate = dateTime.AddDays(1).ToString("yyyy-MM-dd");
            return
                $"-- Объединённый запрос с использованием подзапросов\r\nWITH \r\nautoclave1_Data AS (\r\n    WITH \r\n    UniqueData AS (\r\n        SELECT DISTINCT Data_461\r\n        FROM autoclave1\r\n        WHERE Timestamp >= '{startDate}' AND Timestamp < '{endDate}'\r\n    ),\r\n    AllRelevantRecords AS (\r\n        SELECT a1.Data_461, a1.Timestamp, a1.Data_445, a1.Data_443\r\n        FROM autoclave1 a1\r\n        JOIN UniqueData ud ON a1.Data_461 = ud.Data_461\r\n    ),\r\n    DataTimings AS (\r\n        SELECT \r\n            Data_461,\r\n            MIN(Timestamp) AS FirstTimestamp,\r\n            MAX(Timestamp) AS LastTimestamp,\r\n            LEAD(MIN(Timestamp)) OVER (ORDER BY Data_461) AS NextGroupFirstTimestamp\r\n        FROM AllRelevantRecords\r\n        GROUP BY Data_461\r\n    ),\r\n    FilteredData AS (\r\n        SELECT \r\n            dt.Data_461,\r\n            ar.Timestamp,\r\n            ar.Data_445,\r\n            ar.Data_443,\r\n            dt.FirstTimestamp,\r\n            dt.LastTimestamp,\r\n            dt.NextGroupFirstTimestamp\r\n        FROM AllRelevantRecords ar\r\n        JOIN DataTimings dt ON ar.Data_461 = dt.Data_461\r\n        WHERE ar.Data_443 = 5 AND ar.Data_445 <= 0.08\r\n    ),\r\n    GroupedData AS (\r\n        SELECT \r\n            Data_461 AS Data_ID,\r\n            FirstTimestamp,\r\n            LastTimestamp,\r\n            NextGroupFirstTimestamp,\r\n            COUNT(*) AS CountMeetCondition\r\n        FROM FilteredData\r\n        WHERE NextGroupFirstTimestamp IS NOT NULL AND NextGroupFirstTimestamp > LastTimestamp\r\n        GROUP BY Data_461, FirstTimestamp, LastTimestamp, NextGroupFirstTimestamp\r\n    )\r\n    SELECT \r\n        'Autoclave 1' AS Machine,\r\n        Data_ID,\r\n        FirstTimestamp,\r\n        LastTimestamp,\r\n        NextGroupFirstTimestamp,\r\n        CountMeetCondition,\r\n        TIMEDIFF(NextGroupFirstTimestamp, LastTimestamp) AS TimeDifference\r\n    FROM GroupedData\r\n),\r\nautoclave2_Data AS (\r\n    WITH \r\n    UniqueData AS (\r\n        SELECT DISTINCT Data_92\r\n        FROM autoclave2\r\n        WHERE Timestamp >= '{startDate}' AND Timestamp < '{endDate}'\r\n    ),\r\n    AllRelevantRecords AS (\r\n        SELECT a2.Data_92, a2.Timestamp, a2.Data_60, a2.Data_55\r\n        FROM autoclave2 a2\r\n        JOIN UniqueData ud ON a2.Data_92 = ud.Data_92\r\n    ),\r\n    DataTimings AS (\r\n        SELECT \r\n            Data_92,\r\n            MIN(Timestamp) AS FirstTimestamp,\r\n            MAX(Timestamp) AS LastTimestamp,\r\n            LEAD(MIN(Timestamp)) OVER (ORDER BY Data_92) AS NextGroupFirstTimestamp\r\n        FROM AllRelevantRecords\r\n        GROUP BY Data_92\r\n    ),\r\n    FilteredData AS (\r\n        SELECT \r\n            dt.Data_92,\r\n            ar.Timestamp,\r\n            ar.Data_60,\r\n            ar.Data_55,\r\n            dt.FirstTimestamp,\r\n            dt.LastTimestamp,\r\n            dt.NextGroupFirstTimestamp\r\n        FROM AllRelevantRecords ar\r\n        JOIN DataTimings dt ON ar.Data_92 = dt.Data_92\r\n        WHERE ar.Data_55 = 5 AND ar.Data_60 <= 0.08\r\n    ),\r\n    GroupedData AS (\r\n        SELECT \r\n            Data_92 AS Data_ID,\r\n            FirstTimestamp,\r\n            LastTimestamp,\r\n            NextGroupFirstTimestamp,\r\n            COUNT(*) AS CountMeetCondition\r\n        FROM FilteredData\r\n        WHERE NextGroupFirstTimestamp IS NOT NULL AND NextGroupFirstTimestamp > LastTimestamp\r\n        GROUP BY Data_92, FirstTimestamp, LastTimestamp, NextGroupFirstTimestamp\r\n    )\r\n    SELECT \r\n        'Autoclave 2' AS Machine,\r\n        Data_ID,\r\n        FirstTimestamp,\r\n        LastTimestamp,\r\n        NextGroupFirstTimestamp,\r\n        CountMeetCondition,\r\n        TIMEDIFF(NextGroupFirstTimestamp, LastTimestamp) AS TimeDifference\r\n    FROM GroupedData\r\n),\r\nautoclave3_Data AS (\r\n    WITH \r\n    UniqueData AS (\r\n        SELECT DISTINCT Data_93\r\n        FROM autoclave3\r\n        WHERE Timestamp >= '{startDate}' AND Timestamp < '{endDate}'\r\n    ),\r\n    AllRelevantRecords AS (\r\n        SELECT a3.Data_93, a3.Timestamp, a3.Data_61, a3.Data_57\r\n        FROM autoclave3 a3\r\n        JOIN UniqueData ud ON a3.Data_93 = ud.Data_93\r\n    ),\r\n    DataTimings AS (\r\n        SELECT \r\n            Data_93,\r\n            MIN(Timestamp) AS FirstTimestamp,\r\n            MAX(Timestamp) AS LastTimestamp,\r\n            LEAD(MIN(Timestamp)) OVER (ORDER BY Data_93) AS NextGroupFirstTimestamp\r\n        FROM AllRelevantRecords\r\n        GROUP BY Data_93\r\n    ),\r\n    FilteredData AS (\r\n        SELECT \r\n            dt.Data_93,\r\n            ar.Timestamp,\r\n            ar.Data_61,\r\n            ar.Data_57,\r\n            dt.FirstTimestamp,\r\n            dt.LastTimestamp,\r\n            dt.NextGroupFirstTimestamp\r\n        FROM AllRelevantRecords ar\r\n        JOIN DataTimings dt ON ar.Data_93 = dt.Data_93\r\n        WHERE ar.Data_57 = 5 AND ar.Data_61 <= 0.08\r\n    ),\r\n    GroupedData AS (\r\n        SELECT \r\n            Data_93 AS Data_ID,\r\n            FirstTimestamp,\r\n            LastTimestamp,\r\n            NextGroupFirstTimestamp,\r\n            COUNT(*) AS CountMeetCondition\r\n        FROM FilteredData\r\n        WHERE NextGroupFirstTimestamp IS NOT NULL AND NextGroupFirstTimestamp > LastTimestamp\r\n        GROUP BY Data_93, FirstTimestamp, LastTimestamp, NextGroupFirstTimestamp\r\n    )\r\n    SELECT \r\n        'Autoclave 3' AS Machine,\r\n        Data_ID,\r\n        FirstTimestamp,\r\n        LastTimestamp,\r\n        NextGroupFirstTimestamp,\r\n        CountMeetCondition,\r\n        TIMEDIFF(NextGroupFirstTimestamp, LastTimestamp) AS TimeDifference\r\n    FROM GroupedData\r\n),\r\nautoclave4_Data AS (\r\n    WITH \r\n    UniqueData AS (\r\n        SELECT DISTINCT Data_52\r\n        FROM autoclave4\r\n        WHERE Timestamp >= '{startDate}' AND Timestamp < '{endDate}'\r\n    ),\r\n    AllRelevantRecords AS (\r\n        SELECT a4.Data_52, a4.Timestamp, a4.Data_36, a4.Data_34\r\n        FROM autoclave4 a4\r\n        JOIN UniqueData ud ON a4.Data_52 = ud.Data_52\r\n    ),\r\n    DataTimings AS (\r\n        SELECT \r\n            Data_52,\r\n            MIN(Timestamp) AS FirstTimestamp,\r\n            MAX(Timestamp) AS LastTimestamp,\r\n            LEAD(MIN(Timestamp)) OVER (ORDER BY Data_52) AS NextGroupFirstTimestamp\r\n        FROM AllRelevantRecords\r\n        GROUP BY Data_52\r\n    ),\r\n    FilteredData AS (\r\n        SELECT \r\n            dt.Data_52,\r\n            ar.Timestamp,\r\n            ar.Data_36,\r\n            ar.Data_34,\r\n            dt.FirstTimestamp,\r\n            dt.LastTimestamp,\r\n            dt.NextGroupFirstTimestamp\r\n        FROM AllRelevantRecords ar\r\n        JOIN DataTimings dt ON ar.Data_52 = dt.Data_52\r\n        WHERE ar.Data_34 = 5 AND ar.Data_36 <= 0.08\r\n    ),\r\n    GroupedData AS (\r\n        SELECT \r\n            Data_52 AS Data_ID,\r\n            FirstTimestamp,\r\n            LastTimestamp,\r\n            NextGroupFirstTimestamp,\r\n            COUNT(*) AS CountMeetCondition\r\n        FROM FilteredData\r\n        WHERE NextGroupFirstTimestamp IS NOT NULL AND NextGroupFirstTimestamp > LastTimestamp\r\n        GROUP BY Data_52, FirstTimestamp, LastTimestamp, NextGroupFirstTimestamp\r\n    )\r\n    SELECT \r\n        'Autoclave 4' AS Machine,\r\n        Data_ID,\r\n        FirstTimestamp,\r\n        LastTimestamp,\r\n        NextGroupFirstTimestamp,\r\n        CountMeetCondition,\r\n        TIMEDIFF(NextGroupFirstTimestamp, LastTimestamp) AS TimeDifference\r\n    FROM GroupedData\r\n)\r\n\r\nSELECT FirstTimestamp, Machine, CountMeetCondition, TimeDifference FROM autoclave1_Data\r\nUNION ALL\r\nSELECT FirstTimestamp, Machine, CountMeetCondition, TimeDifference FROM autoclave2_Data\r\nUNION ALL\r\nSELECT FirstTimestamp, Machine, CountMeetCondition, TimeDifference FROM autoclave3_Data\r\nUNION ALL\r\nSELECT FirstTimestamp, Machine, CountMeetCondition, TimeDifference FROM autoclave4_Data;\r\n";
        }

        private readonly string _sqlCodeAutoclaveFull;

        public string GetSqlCode(Autoclave autoclave, DateTime dateTime)
        {
            string sqlCode = null;

            switch(autoclave)
            {
                case Autoclave.Autoclave1:
                    sqlCode = GetSqlCodeAutoclave1(dateTime);
                    break;
                case Autoclave.Autoclave2:
                    sqlCode = GetSqlCodeAutoclave2(dateTime);
                    break;
                case Autoclave.Autoclave3:
                    sqlCode = GetSqlCodeAutoclave3(dateTime);
                    break;
                case Autoclave.Autoclave4:
                    sqlCode = GetSqlCodeAutoclave4(dateTime);
                    break;
                case Autoclave.AutoclaveFull:
                    sqlCode = GetSqlCodeAutoclaveFull(dateTime);
                    break;
                default:
                    sqlCode = "Zero";
                    MessageBox.Show("Ошибка получения autoclave");
                    break;
            }

            return sqlCode;
        }

        private DateTime ReturnsTheNextDay(DateTime dateTime)
        {
            return dateTime.AddDays(1);
        }
    }
}
